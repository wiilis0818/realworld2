<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å…¨çƒæ–°é—»èšåˆ</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Apple MapKit -->
  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>

  <style>
    /* åœ°å›¾ä¸»å®¹å™¨ */
    #mapContainer {
      position: relative;
      margin-left: 12rem; /* ç•™å‡ºä¾§è¾¹æ å®½åº¦ */
      margin-top: 4rem;   /* ç•™å‡ºé¡¶éƒ¨å¯¼èˆªæ é«˜åº¦ */
      width: calc(100vw - 12rem);
      height: calc(100vh - 4rem);
      background-color: #000;
    }

    /* å³ä¾§æŠ½å±‰é¢æ¿ */
    .sheet {
      position: fixed;
      right: -400px;
      top: 4rem;
      width: 400px;
      height: calc(100vh - 4rem);
      background-color: #fff;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease-in-out;
      border-radius: 10px 0 0 10px;
      overflow-y: auto;
      padding: 20px;
    }
    .sheet.show {
      right: 0;
    }

    /* å³ä¸Šè§’é€æ˜é•¿æ–¹å½¢ */
    #transparentBox {
      position: fixed;
      top: 5rem; /* è°ƒæ•´ä½ç½®ç¨å¾®å¾€ä¸‹ */
      right: 1rem;
      width: 300px;
      height: 110px;
      background: rgba(255, 255, 255, 0.5); /* 20% é€æ˜åº¦ */
      border-radius: 10px; /* åœ†è§’ */
      padding: 1rem;
    }

    /* å¤´åƒå ä½ç¬¦ */
    .avatar-placeholder {
      width: 72px;
      height: 72px;
      background: #6b7280;
      border-radius: 100%;
      display: flex; /* è®©å†…éƒ¨å…ƒç´ å±…ä¸­ */
      align-items: center; /* å‚ç›´å±…ä¸­ */
      justify-content: center; /* æ°´å¹³å±…ä¸­ */
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<header class="fixed top-0 left-0 w-full h-16 bg-gray-800 flex items-center px-4 shadow-md z-10">
  <div class="text-xl font-bold">å…¨çƒæ–°é—»èšåˆ</div>
  <div class="ml-auto flex items-center">
    <input type="text" placeholder="æœç´¢å›½å®¶æˆ–å…³é”®è¯..." class="bg-gray-700 text-white px-3 py-1 rounded-l outline-none" id="globalSearchInput"/>
    <button class="bg-blue-600 px-4 py-1 rounded-r hover:bg-blue-500" onclick="globalSearch()">æœç´¢</button>
  </div>
</header>

<!-- å·¦ä¾§ä¾§è¾¹æ ï¼ˆåˆ†ç±»ï¼‰ -->
<aside class="fixed left-0 top-16 h-screen w-48 bg-gray-800 flex flex-col py-4 shadow-lg z-10">
  <nav class="flex flex-col space-y-2 px-3">
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('all')">å…¨éƒ¨æ–°é—»</button>
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('economy')">ç»æµ</button>
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('technology')">ç§‘æŠ€</button>
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('finance')">é‡‘è</button>
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('politics')">æ”¿æ²»/æ”¿ç­–</button>
    <button class="w-full bg-gray-700 hover:bg-gray-600 rounded p-2 text-left" onclick="setCategory('emergency')">ç´§æ€¥æ¶ˆæ¯</button>
  </nav>
</aside>

<!-- åœ°å›¾å®¹å™¨ -->
<div id="mapContainer">
  <div id="map" style="width: 100%; height: 100%;"></div>
</div>

<!-- å³ä¸Šè§’é€æ˜é•¿æ–¹å½¢ -->
<div id="transparentBox">
  <div class="user-avatar">
    <div class="avatar-placeholder"></div>
    <span class="status-indicator"></span>
  </div>
</div>

<!-- å³ä¾§æŠ½å±‰é¢æ¿ï¼šæ–°é—»åˆ—è¡¨ & AI åˆ†æ -->
<div class="sheet" id="newsSheet">
  <h2 class="text-xl font-semibold mb-4" id="countryTitle">å›½å®¶æ–°é—»</h2>
  <div id="newsList" class="space-y-2 text-black"></div>
  <button class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-500" onclick="showAIAnalysis()">AI åˆ†æ</button>
  <div id="aiAnalysisResult" class="mt-2 text-sm text-black bg-gray-200 p-2 rounded hidden"></div>
  <button class="mt-4 w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-400" onclick="hideSheet()">å…³é—­</button>
</div>

<script>
  const token = "eyJraWQiOiI2NDlZUVZaTjJCIiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJNTEg1V0gyUjhLIiwiaWF0IjoxNzQxMzA4MjYwLCJleHAiOjE3NDE5MzU1OTl9.ns6WaU0boac1xN_AsXxuBj806mAoBmDFxUh7JiVdWtuEP8CULfnDZ_3x6xNSu3dpcOLFe1nNfr5sEUN_zmosbw"; // æ›¿æ¢ä¸ºä½ çš„ Apple MapKit Token

  // åˆå§‹åŒ– Apple Maps
  mapkit.init({
    authorizationCallback: function(done) {
      console.log("MapKit æ­£åœ¨åˆå§‹åŒ–...");
      done(token);
    }
  });

var map = new mapkit.Map("map", {
  showsPointsOfInterest: false,
  showsTraffic: false,
  showsMapTypeControl: false, // ä½¿ç”¨ mutedStandard æ¨¡å¼å‡å°‘é“è·¯ç»†èŠ‚
});
// åˆ›å»ºç¾å›½å·ä»½Markerï¼ˆåˆå§‹éšè—ï¼‰
const usaStates = [
  { title: "åŠ åˆ©ç¦å°¼äºšå·", coords: [36.7783, -119.4179] },
  { title: "çº½çº¦å·", coords: [43.2994, -74.2179] },
  { title: "å¾·å…‹è¨æ–¯å·", coords: [31.9686, -99.9018] },
  { title: "ä½›ç½—é‡Œè¾¾å·", coords: [27.9944, -81.7603] },
  { title: "ä¼Šåˆ©è¯ºä¼Šå·", coords: [40.6331, -89.3985] },
  { title: "å®¾å¤•æ³•å°¼äºšå·", coords: [41.2033, -77.1945] },
  { title: "åç››é¡¿å·", coords: [47.7511, -120.7401] },
  { title: "ä½æ²»äºšå·", coords: [32.1656, -82.9001] },
  { title: "æ–°æ³½è¥¿å·", coords: [40.0583, -74.4057] },
  { title: "ä¿„äº¥ä¿„å·", coords: [40.4173, -82.9071] },
  { title: "ä¿„å‹’å†ˆå·", coords: [43.8041, -120.5542] },
  { title: "å†…åè¾¾å·", coords: [38.8026, -116.4194] },
  { title: "äºšåˆ©æ¡‘é‚£å·", coords: [34.0489, -111.0937] },
  { title: "é˜¿æ‹‰æ–¯åŠ å·", coords: [64.2008, -149.4937] },
  { title: "çˆ±è¾¾è·å·", coords: [44.0682, -114.7420] },
  { title: "è’™å¤§æ‹¿å·", coords: [46.8797, -110.3626] },
  { title: "æ€€ä¿„æ˜å·", coords: [43.0760, -107.2903] },
  { title: "ç§‘ç½—æ‹‰å¤šå·", coords: [39.5501, -105.7821] },
  { title: "æ–°å¢¨è¥¿å“¥å·", coords: [34.5199, -105.8701] },
  { title: "å¤å¨å¤·å·", coords: [19.8968, -155.5828] },
  { title: "çŠ¹ä»–å·", coords: [39.3200, -111.0937] },
  { title: "åŒ—è¾¾ç§‘ä»–å·", coords: [47.5515, -101.0020] },
  { title: "å—è¾¾ç§‘ä»–å·", coords: [43.9695, -99.9018] },
  { title: "å†…å¸ƒæ‹‰æ–¯åŠ å·", coords: [41.4925, -99.9018] },
  { title: "å ªè¨æ–¯å·", coords: [39.0119, -98.4842] },
  { title: "ä¿„å…‹æ‹‰è·é©¬å·", coords: [35.0078, -97.0929] },
  { title: "æ˜å°¼è‹è¾¾å·", coords: [46.7296, -94.6859] },
  { title: "è‰¾å¥¥ç“¦å·", coords: [41.8780, -93.0977] },
  { title: "å¯†è‹é‡Œå·", coords: [38.5739, -92.6038] },
  { title: "é˜¿è‚¯è‰²å·", coords: [34.7465, -92.2896] },
  { title: "è·¯æ˜“æ–¯å®‰é‚£å·", coords: [30.9843, -91.9623] },
  { title: "å¯†è¥¿è¥¿æ¯”å·", coords: [32.3547, -89.3985] },
  { title: "å¯†æ­‡æ ¹å·", coords: [44.3148, -85.6024] },
  { title: "å°ç¬¬å®‰çº³å·", coords: [39.7684, -86.1581] },
  { title: "è‚¯å¡”åŸºå·", coords: [37.8393, -84.2700] },
  { title: "ç¼…å› å·", coords: [45.2538, -69.4455] },
  { title: "è¥¿å¼—å‰å°¼äºšå·", coords: [38.5976, -80.4549] },
  { title: "ç”°çº³è¥¿å·", coords: [35.5175, -86.5804] },
  { title: "é˜¿æ‹‰å·´é©¬å·", coords: [32.8067, -86.7911] },
  { title: "ç‰¹æ‹‰åå·", coords: [38.9108, -75.5277] },
  { title: "æ–°ç½•å¸ƒä»€å°”å·", coords: [43.1939, -71.5724] },
  { title: "ä½›è’™ç‰¹å·", coords: [44.5588, -72.5778] },
  { title: "é©¬è¨è¯¸å¡å·", coords: [42.4072, -71.3824] },
  { title: "å¨æ–¯åº·æ˜Ÿå·", coords: [43.7844, -88.7879] },
  { title: "å—å¡ç½—æ¥çº³å·", coords: [33.8361, -81.1637] },
  { title: "åŒ—å¡ç½—æ¥çº³å·", coords: [35.7596, -79.0193] },
  { title: "å¼—å‰å°¼äºšå·", coords: [37.4316, -78.6569] },
  { title: "åº·æ¶…ç‹„æ ¼å·", coords: [41.6032, -73.0877] },
  { title: "é©¬é‡Œå…°å·", coords: [39.0458, -76.6413] }
].map(state => {
  let marker = new mapkit.MarkerAnnotation(new mapkit.Coordinate(...state.coords), {
    title: state.title,
    visible: false,
    color: "#e74c3c"
  });
  map.addAnnotation(marker);
  return marker;
});

// è®©ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªå·åï¼Œéšè—å…¶ä»–å· Markerï¼Œä»…æ˜¾ç¤ºè¢«é€‰ä¸­çš„ Marker
usaStates.forEach(marker => {
  marker.addEventListener("select", () => {
    usaStates.forEach(m => {
      if (m === marker) {
        m.visible = true; // é€‰ä¸­çš„ Marker ä»ç„¶å¯è§
      } else {
        m.visible = false; // å…¶ä»– Marker è¢«éšè—
      }
    });
  });
});

// åˆ›å»ºè‹±å›½çš„åŸå¸‚ Markerï¼ˆåˆå§‹éšè—ï¼Œçº¢è‰²ï¼‰
const ukRegions = [
  { title: "ä¼¦æ•¦", coords: [51.5074, -0.1278] },
  { title: "ä¼¯æ˜ç¿°", coords: [52.4862, -1.8904] },
  { title: "æ ¼æ‹‰æ–¯å“¥", coords: [55.8642, -4.2518] },
  { title: "åˆ©ç‰©æµ¦", coords: [53.4084, -2.9916] },
  { title: "å¸ƒé‡Œæ–¯æ‰˜å°”", coords: [51.4545, -2.5879] }
].map(city => {
  let marker = new mapkit.MarkerAnnotation(new mapkit.Coordinate(...city.coords), {
    title: city.title,
    visible: false,
    color: "#e74c3c"
  });
  map.addAnnotation(marker);
  return marker;
});

// ä¿®æ”¹ showSheet() å‡½æ•°ï¼Œæ§åˆ¶è‹±å›½çœä»½ Marker æ˜¾ç¤º/éšè—
const originalShowSheet = showSheet;
showSheet = function(countryName) {
  originalShowSheet(countryName);

  if (countryName === "United Kingdom" || countryName === "è‹±å›½") {
    ukRegions.forEach(marker => marker.visible = true);
  } else {
    ukRegions.forEach(marker => marker.visible = false);
  }
};

// ä¿®æ”¹ showSheet()å‡½æ•°ä»¥å¤„ç†ç¾å›½Markerçš„æ˜¾ç¤ºå’Œéšè—
const originalShowSheetUSA = showSheet;
showSheet = function(countryName) {
  originalShowSheetUSA(countryName);

  if (countryName === "United States" || countryName === "ç¾å›½") {
    usaStates.forEach(marker => marker.visible = true);
  } else {
    usaStates.forEach(marker => marker.visible = false);
  }
};

// åˆ›å»ºåŠ æ‹¿å¤§æ‰€æœ‰çœä»½å’Œåœ°åŒºçš„ Markerï¼ˆåˆå§‹çŠ¶æ€éšè—ï¼Œç‚¹å‡»åŠ æ‹¿å¤§æ—¶æ˜¾ç¤ºï¼‰
const canadaMarkers = [
  { title: "é˜¿å°”ä¼¯å¡”çœ", coords: [53.9333, -116.5765] },
  { title: "ä¸åˆ—é¢ å“¥ä¼¦æ¯”äºšçœ", coords: [53.7267, -127.6476] },
  { title: "æ›¼å°¼æ‰˜å·´çœ", coords: [53.7609, -98.8139] },
  { title: "æ–°ä¸ä¼¦ç‘å…‹çœ", coords: [46.5653, -66.4619] },
  { title: "çº½èŠ¬å…°ä¸æ‹‰å¸ƒæ‹‰å¤šçœ", coords: [53.1355, -57.6604] },
  { title: "æ–°æ–¯ç§‘èˆçœ", coords: [44.6820, -63.7443] },
  { title: "å®‰å¤§ç•¥çœ", coords: [51.2538, -85.3232] },
  { title: "çˆ±å¾·åç‹å­å²›çœ", coords: [46.5107, -63.4168] },
  { title: "é­åŒ—å…‹çœ", coords: [52.9399, -73.5491] },
  { title: "è¨æ–¯å–€å½»æ¸©çœ", coords: [52.9399, -106.4509] }
].map(region => {
  let marker = new mapkit.MarkerAnnotation(new mapkit.Coordinate(...region.coords), {
    title: region.title,
    visible: false,
    color: "#e74c3c"
  });
  map.addAnnotation(marker);
  return marker;
});

// å½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªåŠ æ‹¿å¤§çœçš„ Marker æ—¶ï¼Œéšè—å…¶ä»–çœ Markerï¼Œä»…æ˜¾ç¤ºè¢«é€‰ä¸­çš„ Marker
canadaMarkers.forEach(marker => {
  marker.addEventListener("select", () => {
    canadaMarkers.forEach(m => {
      m.visible = (m === marker); // åªæœ‰è¢«é€‰ä¸­çš„ Marker å¯è§ï¼Œå…¶ä»– Marker éšè—
    });
  });
});

// åŠ æ‹¿å¤§å„çœçš„åŸå¸‚æ•°æ®ï¼ˆå·²å†™æ­»ï¼‰
const provinceCities = {
  "å®‰å¤§ç•¥çœ": [
    { title: "å¤šä¼¦å¤š", coords: [43.6532, -79.3832] },
    { title: "æ¸¥å¤ªå", coords: [45.4215, -75.6994] }
  ],
  "é­åŒ—å…‹çœ": [
    { title: "è’™ç‰¹åˆ©å°”", coords: [45.5017, -73.5673] },
    { title: "é­åŒ—å…‹å¸‚", coords: [46.8139, -71.2080] }
  ],
  "ä¸åˆ—é¢ å“¥ä¼¦æ¯”äºšçœ": [
    { title: "Vancouver", coords: [49.2827, -123.1207] },
    { title: "Victoria", coords: [48.4284, -123.3656] },
    { title: "Whistler", coords: [50.1163, -122.9574] }
  ],
  "é˜¿å°”ä¼¯å¡”çœ": [
    { title: "å¡å°”åŠ é‡Œ", coords: [51.0447, -114.0719] },
    { title: "åŸƒå¾·è’™é¡¿", coords: [53.5461, -113.4938] }
  ],
  "æ›¼å°¼æ‰˜å·´çœ": [
    { title: "æ¸©å°¼ä¼¯", coords: [49.8951, -97.1384] }
  ],
  "è¨æ–¯å–€å½»æ¸©çœ": [
    { title: "è¨æ–¯å¡é€š", coords: [52.1579, -106.6702] },
    { title: "é‡Œè´¾çº³", coords: [50.4452, -104.6189] }
  ],
  "æ–°æ–¯ç§‘èˆçœ": [
    { title: "å“ˆåˆ©æ³•å…‹æ–¯", coords: [44.6488, -63.5752] }
  ],
  "æ–°ä¸ä¼¦ç‘å…‹çœ": [
    { title: "å¼—é›·å¾·é‡Œå…‹é¡¿", coords: [45.9636, -66.6431] }
  ],
  "çº½èŠ¬å…°ä¸æ‹‰å¸ƒæ‹‰å¤šçœ": [
    { title: "åœ£çº¦ç¿°æ–¯", coords: [47.5615, -52.7126] }
  ],
  "çˆ±å¾·åç‹å­å²›çœ": [
    { title: "å¤æ´›ç‰¹æ•¦", coords: [46.2382, -63.1311] }
  ],
  "è‚²ç©ºåœ°åŒº": [
    { title: "æ€€ç‰¹éœæ–¯", coords: [60.7212, -135.0568] }
  ],
  "è¥¿åŒ—åœ°åŒº": [
    { title: "è€¶æ´›å¥ˆå¤«", coords: [62.4540, -114.3718] }
  ],
  "åŠªçº³æ­¦ç‰¹åœ°åŒº": [
    { title: "ä¼Šé­ç‰¹", coords: [63.7467, -68.5169] }
  ]
};

// ç”¨äºå­˜å‚¨åŸå¸‚ Marker
let cityMarkers = [];

// ç»™æ‰€æœ‰çœ Marker æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºå¯¹åº”åŸå¸‚ Marker
canadaMarkers.forEach(marker => {
  marker.addEventListener("select", () => {
    // æ¸…ç©ºå¹¶éšè—å·²æœ‰åŸå¸‚ Marker
    cityMarkers.forEach(m => map.removeAnnotation(m));
    cityMarkers = [];

    const cities = provinceCities[marker.title];
    if (cities) {
      cities.forEach(city => {
        let cityMarker = new mapkit.MarkerAnnotation(new mapkit.Coordinate(...city.coords), {
          title: city.title,
          color: "#3498db",
          visible: true
        });
        map.addAnnotation(cityMarker);
        cityMarkers.push(cityMarker);
      });
    }
  });
});

  // åˆ›å»ºæ ‡è®°ä½†é»˜è®¤éšè—
  const torontoCoordinate = new mapkit.Coordinate(43.6532, -79.3832);
  const torontoMarker = new mapkit.MarkerAnnotation(torontoCoordinate, {
    title: "Toronto",
    subtitle: "åŠ æ‹¿å¤§å¤šä¼¦å¤š",
    color: "#e74c3c",
    visible: false // åˆå§‹çŠ¶æ€ä¸ºéšè—
  });
  map.addAnnotation(torontoMarker);

  setTimeout(() => {
    console.log("åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œç›‘å¬ç‚¹å‡»äº‹ä»¶...");
    map.addEventListener("single-tap", handleMapClick);
  }, 1000);

  function handleMapClick(event) {
    var coordinate = event.coordinate || map.convertPointOnPageToCoordinate(event.pointOnPage);
    if (!coordinate) return;

    var mapkitCoordinate = new mapkit.Coordinate(coordinate.latitude, coordinate.longitude);
    var geocoder = new mapkit.Geocoder();

    geocoder.reverseLookup(mapkitCoordinate, function(error, data) {
      if (error || data.results.length === 0) {
        document.getElementById("countryTitle").textContent = "æœªçŸ¥å›½å®¶";
        return;
      }

      let country = data.results[0].country || "æœªçŸ¥å›½å®¶";
      console.log("ç”¨æˆ·ç‚¹å‡»çš„å›½å®¶:", country);
      showSheet(country);
    });
  }

  function showSheet(countryName) {
    document.getElementById("countryTitle").innerText = countryName;
    updateNewsList(countryName);

    if (countryName === "Canada" || countryName === "åŠ æ‹¿å¤§") {
      canadaMarkers.forEach(marker => marker.visible = true);
    } else {
      canadaMarkers.forEach(marker => marker.visible = false);
      cityMarkers.forEach(marker => marker.visible = false); // æ·»åŠ è¿™ä¸€è¡Œä»¥éšè—åŸå¸‚ Marker
    }

    document.getElementById("newsList").innerHTML = "<div>åŠ è½½æ–°é—»ä¸­...</div>";
  }

  function hideSheet() {
    document.getElementById("newsSheet").classList.remove("show");
  }
  // ========== ä½¿ç”¨ Mediastack è·å–æ–°é—»æ•°æ® ==========
  const API_KEY = "5cd56f3543ac8e93d3313f7af75daba7"; // è¯·æ›¿æ¢ä¸ºä½ çš„ API Key

  async function fetchNewsData(countryName) {
    const countryCodeMapping = {
      "China": "cn",
      "United States": "us",
      "United Kingdom": "gb",
      "France": "fr",
      "Germany": "de"
    };

    const countryCode = countryCodeMapping[countryName] || "";
    let url = `https://api.mediastack.com/v1/news?access_key=${API_KEY}&countries=${countryCode}&limit=10`;

    console.log("Fetching news from URL:", url);

    try {
      const response = await fetch(url);
      const data = await response.json();
      console.log("Mediastack response:", data);
      return data.data || [];
    } catch (error) {
      console.error("Fetch error:", error);
      return [];
    }
  }

  async function updateNewsList(countryName) {
    console.log("Updating news list for:", countryName);
    document.getElementById("newsList").innerHTML = "<div>æ­£åœ¨åŠ è½½æ–°é—»...</div>";

    let articles = await fetchNewsData(countryName); // ğŸ”¥ ç¡®ä¿ fetchNewsData å­˜åœ¨

    if (articles.length === 0) {
      document.getElementById("newsList").innerHTML = "<div>æš‚æ— ç›¸å…³æ–°é—»</div>";
      return;
    }

    document.getElementById("newsList").innerHTML = "";
    articles.forEach(article => {
      let item = document.createElement("div");
      item.className = "bg-gray-100 p-3 rounded";
      item.innerHTML = `<div class="font-semibold">${article.title}</div>
                          <div class="text-gray-700 text-sm">${article.description || ""}</div>
                          <a href="${article.url}" target="_blank" class="text-blue-600 text-xs">é˜…è¯»å…¨æ–‡</a>`;
      document.getElementById("newsList").appendChild(item);
    });
  }
</script>

</body>
</html>
