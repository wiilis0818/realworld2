<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• - æˆ‘çš„ç½‘ç«™</title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <style>
    @font-face {
      font-family: 'RealWorld';
      src: url('RealWorld.woff2') format('woff2'); /* ä½ éœ€è¦æä¾›è¿™ä¸ªå­—ä½“ */
    }
    body {
      font-family: 'RealWorld', sans-serif;
      background-color: #1E1E1E; /* æ·±ç©ºç° */
    }
    /* å·¦ä¾§åœ°çƒåŒºåŸŸ */
    #globe-container {
      width: 40%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    /* è®©è§†é¢‘é€‚é…æ•´ä¸ªå®¹å™¨ */
    #globe-video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover; /* è®©è§†é¢‘å¡«å……æ•´ä¸ªåŒºåŸŸ */
    }
    /* å³ä¾§ç™»å½• */
    #login-container {
      width: 60%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="flex h-screen">

<!-- å·¦ä¾§ç§‘æŠ€åœ°çƒï¼ˆä½¿ç”¨ Firebase è§†é¢‘ï¼‰ -->
<div id="globe-container">
  <video id="globe-video" autoplay loop muted playsinline>
    <source src="https://firebasestorage.googleapis.com/v0/b/willistest-40dff.firebasestorage.app/o/1992-153555258.mp4?alt=media&token=466bde93-8ab3-4afa-9a77-9b47fa180a50" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</div>

<!-- å³ä¾§ç™»å½•è¡¨å• -->
<div id="login-container">
  <div class="max-w-md w-full px-6">
    <h1 class="text-3xl font-bold text-white text-center mb-6">Sign in or create an account</h1>
    <p class="text-gray-400 text-sm text-center mb-6">
      By continuing, including through our platform partners, you agree to our
      <a href="#" class="underline">User Agreement</a> and acknowledge our
      <a href="#" class="underline">Privacy Policy</a>.
    </p>

    <form onsubmit="event.preventDefault(); loginOrRegister();">
      <input type="email" id="email" placeholder="Email address"
             class="w-full border border-gray-500 bg-gray-700 text-white px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-gray-400">
      <input type="password" id="password" placeholder="Enter password"
             class="w-full border border-gray-500 bg-gray-700 text-white px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-gray-400">
      <input type="password" id="confirmPassword" placeholder="Confirm password"
             style="display: none;"
             class="w-full border border-gray-500 bg-gray-700 text-white px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-gray-400">
      <button type="submit" id="submitButton" class="w-full bg-[#6A5ACD] text-white py-3 font-medium hover:opacity-80">LOGIN AND REGISTER WITH EMAIL</button>
    </form>
    <p id="errorMessage" class="text-red-500 text-center mt-4"></p>



  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjKBRRKgOmn1riONPsYEC0G9h-47EL9ug",
    authDomain: "realworld.today",
    projectId: "willistest-40dff",
    storageBucket: "willistest-40dff.firebasestorage.app",
    messagingSenderId: "524383134160",
    appId: "1:524383134160:web:2fe912a3d5d2ad268c19d5",
    measurementId: "G-27HNC6CGVW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  console.log("ğŸ”¥ Firebase åˆå§‹åŒ–æˆåŠŸï¼", app);

  async function checkIfEmailExists(email) {
    const apiKey = "AIzaSyAjKBRRKgOmn1riONPsYEC0G9h-47EL9ug";
    try {
      const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:createAuthUri?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          identifier: email,
          continueUri: "https://realworld.today"
        })
      });
      console.log("âœ… Raw email check response status:", response.status);
      const clone = response.clone();
      console.log("âœ… Raw email check response body:", await clone.text());
      if (!response.ok) {
        console.warn("Failed to check email existence", await response.text());
        return undefined;
      }
      const data = await response.json();
      if (data.hasOwnProperty('registered')) {
        console.log("âœ… Email registered status:", data.registered);
        return data.registered === true;
      } else {
        console.log("âœ… Email not registered, 'registered' field missing");
        return false;
      }
    } catch (err) {
      console.warn("Email existence check error", err);
      return undefined;
    }
  }

  async function loginOrRegister() {
    let email = document.getElementById("email").value;
    let password = document.getElementById("password").value;
    let confirmPassword = document.getElementById("confirmPassword");
    let errorMessage = document.getElementById("errorMessage");

    if (confirmPassword.style.display === "block") {
      if (password !== confirmPassword.value) {
        errorMessage.style.color = "red";
        errorMessage.textContent = "âŒ ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥ï¼";
        return;
      }
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("âœ… æ³¨å†ŒæˆåŠŸ", userCredential.user);
          errorMessage.style.color = "green";
          errorMessage.textContent = "âœ… æ³¨å†ŒæˆåŠŸï¼";
          window.location.href = "mappage1.html";
        })
        .catch((error) => {
          console.error("âŒ æ³¨å†Œå¤±è´¥", error.code, error.message);
          errorMessage.style.color = "red";
          errorMessage.textContent = "âŒ æ³¨å†Œå¤±è´¥ï¼š" + error.message;
        });
    } else {
      const exists = await checkIfEmailExists(email);
      if (exists) {
        // Login flow
        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
            console.log("âœ… ç™»å½•æˆåŠŸ", userCredential.user);
            errorMessage.style.color = "green";
            errorMessage.textContent = "âœ… ç™»å½•æˆåŠŸï¼";
            window.location.href = "mappage1.html";
          })
          .catch((error) => {
            console.error("âŒ ç™»å½•å¤±è´¥", error.code, error.message);
            if (error.code === 'auth/wrong-password') {
              errorMessage.style.color = "red";
              errorMessage.textContent = "âŒ Wrong password, please check and try again!";
            } else {
              errorMessage.style.color = "red";
              errorMessage.textContent = "âŒ ç™»å½•å¤±è´¥ï¼š" + error.message;
            }
          });
      } else {
        // Prompt registration
        errorMessage.style.color = "orange";
        errorMessage.textContent = "User not found, please enter the confirmation password and click again to complete the registration";
        confirmPassword.style.display = "block";
        document.getElementById("submitButton").textContent = "REGISTER";
      }
    }
  }
  window.loginOrRegister = loginOrRegister;

  const provider = new GoogleAuthProvider();

  function loginWithGoogle() {
    signInWithPopup(auth, provider)
      .then((result) => {
        const user = result.user;
        console.log("âœ… Google ç™»å½•æˆåŠŸ", user);

        let errorMessage = document.getElementById("errorMessage");
        if (errorMessage) {
          errorMessage.style.color = "green";
          errorMessage.textContent = "âœ… Google ç™»å½•æˆåŠŸï¼";
        }

        window.location.href = "mappage1.html";
      })
      .catch((error) => {
        console.error("âŒ Google ç™»å½•å¤±è´¥", error);
        let errorMessage = document.getElementById("errorMessage");
        if (errorMessage) {
          errorMessage.style.color = "red";
          errorMessage.textContent = "âŒ Google ç™»å½•å¤±è´¥ï¼š" + error.message;
        }
      });
  }
  window.loginWithGoogle = loginWithGoogle;
</script>
</body>
</html>
